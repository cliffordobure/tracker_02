# Mobile App FCM Token Guide

## Problem

The mobile app is sending placeholder values like `"device_token"` instead of real FCM device tokens. This prevents push notifications from working.

## Real FCM Token Format

**Real FCM tokens:**
- Are **140+ characters long**
- Are **alphanumeric strings** (letters and numbers)
- Look like: `cXyZ123abc456def789ghi012jkl345mno678pqr901stu234vwx567yz890ABC123DEF456GHI789JKL012MNO345PQR678STU901VWX234YZ567`
- Are generated by Firebase SDK on the device

**Placeholder tokens (WRONG):**
- ‚ùå `"device_token"`
- ‚ùå `"test_token"`
- ‚ùå `"placeholder"`
- ‚ùå Any string less than 50 characters

---

## How to Get Real FCM Token in Mobile App

### Android (Kotlin/Java)

```kotlin
// Add Firebase Messaging dependency
// implementation 'com.google.firebase:firebase-messaging:23.0.0'

import com.google.firebase.messaging.FirebaseMessaging

// Get FCM token
FirebaseMessaging.getInstance().token.addOnCompleteListener { task ->
    if (!task.isSuccessful) {
        Log.w(TAG, "Fetching FCM registration token failed", task.exception)
        return@addOnCompleteListener
    }

    // Get new FCM registration token
    val token = task.result
    Log.d(TAG, "FCM Registration Token: $token")
    
    // Send token to backend during login
    sendTokenToBackend(token)
}
```

### Android (Java)

```java
FirebaseMessaging.getInstance().getToken()
    .addOnCompleteListener(new OnCompleteListener<String>() {
        @Override
        public void onComplete(@NonNull Task<String> task) {
            if (!task.isSuccessful()) {
                Log.w(TAG, "Fetching FCM registration token failed", task.getException());
                return;
            }

            // Get new FCM registration token
            String token = task.getResult();
            Log.d(TAG, "FCM Registration Token: " + token);
            
            // Send token to backend during login
            sendTokenToBackend(token);
        }
    });
```

### iOS (Swift)

```swift
import FirebaseMessaging

// Request notification permissions first
UNUserNotificationCenter.current().requestAuthorization(options: [.alert, .sound, .badge]) { granted, error in
    if granted {
        // Get FCM token
        Messaging.messaging().token { token, error in
            if let error = error {
                print("Error fetching FCM registration token: \(error)")
            } else if let token = token {
                print("FCM registration token: \(token)")
                // Send token to backend during login
                sendTokenToBackend(token)
            }
        }
    }
}
```

### React Native

```javascript
import messaging from '@react-native-firebase/messaging';

// Request notification permissions
async function requestUserPermission() {
  const authStatus = await messaging().requestPermission();
  const enabled =
    authStatus === messaging.AuthorizationStatus.AUTHORIZED ||
    authStatus === messaging.AuthorizationStatus.PROVISIONAL;

  if (enabled) {
    console.log('Authorization status:', authStatus);
    
    // Get FCM token
    const token = await messaging().getToken();
    console.log('FCM Registration Token:', token);
    
    // Send token to backend during login
    sendTokenToBackend(token);
  }
}

// Call on app start
requestUserPermission();
```

### Flutter

```dart
import 'package:firebase_messaging/firebase_messaging.dart';

// Request notification permissions
FirebaseMessaging messaging = FirebaseMessaging.instance;

NotificationSettings settings = await messaging.requestPermission(
  alert: true,
  badge: true,
  sound: true,
);

if (settings.authorizationStatus == AuthorizationStatus.authorized) {
  // Get FCM token
  String? token = await messaging.getToken();
  print('FCM Registration Token: $token');
  
  // Send token to backend during login
  sendTokenToBackend(token);
}
```

---

## Sending Token to Backend During Login

### Example API Call

```javascript
// During login
const login = async (email, password) => {
  // Get FCM token first
  const fcmToken = await getFCMToken(); // Use platform-specific method above
  
  // Login with token
  const response = await fetch('https://your-backend-url/api/auth/driver/login', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      email: email,
      password: password,
      deviceToken: fcmToken  // Real FCM token, not placeholder!
    })
  });
  
  return response.json();
};
```

---

## Token Refresh

FCM tokens can change. Listen for token refresh:

### Android

```kotlin
FirebaseMessaging.getInstance().token.addOnCompleteListener { task ->
    // Handle token refresh
}

// Or use token refresh callback
FirebaseMessaging.getInstance().token.addOnTokenRefresh { token ->
    // Update token on backend
    updateTokenOnBackend(token)
}
```

### iOS

```swift
Messaging.messaging().token { token, error in
    // Handle token
}

// Listen for token refresh
Messaging.messaging().delegate = self

func messaging(_ messaging: Messaging, didReceiveRegistrationToken fcmToken: String?) {
    // Update token on backend
    updateTokenOnBackend(fcmToken)
}
```

### React Native

```javascript
// Listen for token refresh
messaging().onTokenRefresh(token => {
  console.log('FCM Token refreshed:', token);
  // Update token on backend
  updateTokenOnBackend(token);
});
```

---

## Backend Validation

The backend now validates tokens and will:
- ‚úÖ Accept real FCM tokens (140+ characters)
- ‚ö†Ô∏è Reject placeholder tokens like `"device_token"`
- üìù Log warnings when invalid tokens are received

---

## Testing

### Test with Real Token

1. **Get a real FCM token** from your mobile app
2. **Send it during login:**
   ```json
   {
     "email": "driver2@gmail.com",
     "password": "password",
     "deviceToken": "cXyZ123abc456def789ghi012jkl345mno678pqr901stu234vwx567yz890ABC123DEF456GHI789JKL012MNO345PQR678STU901VWX234YZ567"
   }
   ```

3. **Check backend logs:**
   ```
   ‚úÖ Device token updated for driver driver2@gmail.com (cXyZ123abc456def789...)
   ```

### Test with Placeholder (Will be Rejected)

```json
{
  "email": "driver2@gmail.com",
  "password": "password",
  "deviceToken": "device_token"
}
```

**Backend will log:**
```
‚ö†Ô∏è  Invalid device token format for driver driver2@gmail.com. Token appears to be a placeholder.
   Received: "device_token"
   Real FCM tokens are 140+ character alphanumeric strings.
```

---

## Common Issues

### 1. Token is "device_token" or similar
**Problem:** Mobile app is sending placeholder value  
**Solution:** Implement FCM token retrieval (see code examples above)

### 2. Token is null/undefined
**Problem:** FCM not initialized or permissions not granted  
**Solution:** 
- Initialize Firebase SDK
- Request notification permissions
- Wait for token before sending to backend

### 3. Token not updating
**Problem:** Not listening for token refresh  
**Solution:** Implement token refresh listener (see examples above)

### 4. Token too short
**Problem:** Token is truncated or invalid  
**Solution:** Ensure full token is sent (should be 140+ characters)

---

## Checklist for Mobile App

- [ ] Firebase SDK is initialized
- [ ] Notification permissions are requested
- [ ] FCM token is retrieved using platform-specific method
- [ ] Token is sent during login (not placeholder)
- [ ] Token refresh is handled
- [ ] Token is updated on backend when it changes
- [ ] Token validation passes (140+ characters)

---

## Summary

**The Problem:**
- Mobile app is sending `"device_token"` (placeholder)
- Backend accepts it but it's not a real FCM token
- Push notifications won't work

**The Solution:**
1. Get real FCM token from Firebase SDK
2. Send real token during login
3. Handle token refresh
4. Backend will validate and accept real tokens

**Real FCM tokens are 140+ character alphanumeric strings generated by Firebase SDK!**


